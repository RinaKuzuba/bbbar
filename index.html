<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>リアルタイムバーコード照合</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.5/minified/html5-qrcode.min.js"></script>
  <style>
    #reader { width: 100%; max-width: 400px; margin: auto; }
    .status { text-align: center; font-size: 1.2rem; margin-top: 1rem; }
    .values { text-align: center; margin-top: 0.5rem; font-size: 1rem; }
    .values p { margin: 0.25rem 0; }
    #overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.7);
      align-items: center;
      justify-content: center;
      font-size: 10rem;
      z-index: 999;
    }
  </style>
</head>
<body>
  <div id="reader"></div>
  <div id="status" class="status">１回目のスキャンをしてください</div>
  <div class="values">
    <p>バーコード①：<span id="code1">—</span></p>
    <p>バーコード②：<span id="code2">—</span></p>
  </div>
  <div id="overlay"></div>

  <script>
    let code1 = null;
    let code2 = null;

    const statusEl  = document.getElementById('status');
    const code1El   = document.getElementById('code1');
    const code2El   = document.getElementById('code2');
    const overlayEl = document.getElementById('overlay');

    function resetAll() {
      // 変数クリア
      code1 = null;
      code2 = null;
      // 画面表示クリア
      code1El.textContent = '—';
      code2El.textContent = '—';
      statusEl.textContent = '１回目のスキャンをしてください';
    }

    function showResult(isMatch) {
      overlayEl.textContent = isMatch ? '〇' : '×';
      overlayEl.style.color = isMatch ? 'green' : 'red';
      overlayEl.style.display = 'flex';
      // 2秒後にオーバーレイを消し、変数と表示をクリア
      setTimeout(() => {
        overlayEl.style.display = 'none';
        resetAll();  // ←ここで code1, code2 と UI をクリア
      }, 2000);
    }

    function onScanSuccess(decodedText) {
      if (code1 === null) {
        code1 = decodedText;
        code1El.textContent = code1;
        statusEl.textContent = '２回目のスキャンをしてください';
      } else if (code2 === null) {
        code2 = decodedText;
        code2El.textContent = code2;
        // 照合して結果表示
        showResult(code1 === code2);
      }
    }

    const html5QrCode = new Html5Qrcode('reader');
    html5QrCode.start(
      { facingMode: 'environment' },
      { fps: 10, qrbox: { width: 300, height: 300 } },
      (decodedText, decodedResult) => { onScanSuccess(decodedText); }
    ).catch(err => {
      statusEl.textContent = `カメラ起動エラー：${err}`;
      statusEl.className = 'status ng';
    });

    // ページ読み込み時に初期化
    resetAll();
  </script>
</body>
</html>
