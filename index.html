<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>リアルタイムバーコード照合（QR＆GS1限定型）</title>
  <!-- HTML5-QRCode ライブラリ (複数のCDNでフォールバック) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"
          integrity="sha512-r6rDA7W6ZeQhvl8S7yRVQUKVHdexq+GAlNkNNqVC7YyIV+NwqCTJe2hDWCiffTyRNOeGEzRRJ9ifvRm/HCzGYg=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    // フォールバック用：最初のCDNが失敗した場合
    if (typeof Html5Qrcode === 'undefined') {
      document.write('<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"><\/script>');
    }
  </script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 1rem;
      padding: 0;
    }
    #debug {
      background: #f0f0f0;
      border: 1px solid #ccc;
      padding: 0.8rem;
      margin-bottom: 1rem;
      border-radius: 4px;
      white-space: pre-wrap;
      font-size: 0.8rem;
      max-height: 200px;
      overflow-y: auto;
    }
    #reader {
      width: 100%;
      max-width: 400px;
      height: 300px;
      margin: 1rem auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
    }
    .status {
      text-align: center;
      font-size: 1.2rem;
      margin-top: 1rem;
    }
    .status.ok { color: green; }
    .status.ng { color: red; }
    .values {
      text-align: center;
      margin-top: 0.5rem;
      font-size: 1rem;
    }
    .values p { margin: 0.25rem 0; }
    #overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.9);
      align-items: center;
      justify-content: center;
      font-size: 4rem;
      z-index: 999;
      text-align: center;
      padding: 2rem;
      box-sizing: border-box;
    }
    #overlay.barcode {
      font-size: 2rem;
      background: rgba(0, 123, 255, 0.9);
      color: white;
    }
    #overlay.result {
      font-size: 8rem;
    }
    button {
      display: block;
      margin: 1rem auto;
      padding: 0.8rem 1.5rem;
      font-size: 1.1rem;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      width: 200px;
      max-width: 90%;
    }
    button:hover { background: #0056b3; }
    button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <!-- デバッグ情報表示 -->
  <div id="debug">デバッグ情報を表示中...</div>
  
  <!-- 開始／停止ボタン -->
  <button id="startBtn">カメラを開始</button>
  <button id="stopBtn" style="display:none;">カメラを停止</button>
  
  <!-- カメラ映像エリア -->
  <div id="reader"></div>
  
  <!-- 操作ステータス -->
  <div id="status" class="status">カメラを開始してください</div>
  
  <!-- 読み取り値の表示 -->
  <div class="values">
    <p>バーコード①：<span id="code1">—</span></p>
    <p>バーコード②：<span id="code2">—</span></p>
  </div>
  
  <!-- 〇／× オーバーレイ -->
  <div id="overlay"></div>

  <script>
    // グローバルエラーキャッチャー
    window.addEventListener('error', event => {
      addDebugLog(`Unhandled Error: ${event.message} (at ${event.filename}:${event.lineno})`);
    });

    let code1 = null, code2 = null;
    let html5QrCode = null, isScanning = false;

    const debugEl  = document.getElementById('debug');
    const startBtn = document.getElementById('startBtn');
    const stopBtn  = document.getElementById('stopBtn');
    const statusEl = document.getElementById('status');
    const code1El  = document.getElementById('code1');
    const code2El  = document.getElementById('code2');
    const overlayEl= document.getElementById('overlay');

    // デバッグログ出力
    function addDebugLog(msg) {
      const t = new Date().toLocaleTimeString();
      debugEl.textContent += `[${t}] ${msg}\n`;
      debugEl.scrollTop = debugEl.scrollHeight;
      console.log(msg);
    }

    // 環境チェック
    function checkEnvironment() {
      addDebugLog('=== 環境チェック開始 ===');
      addDebugLog(`URL: ${location.href}`);
      addDebugLog(`プロトコル: ${location.protocol}`);
      addDebugLog(`UA: ${navigator.userAgent}`);
      if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        addDebugLog('警告: HTTPSではありません。カメラが動作しない可能性あり。');
      }
      if (!navigator.mediaDevices?.getUserMedia) {
        addDebugLog('エラー: getUserMedia未サポート');
        return false;
      }
      addDebugLog('getUserMedia利用可');
      return true;
    }

    // カメラ一覧取得
    async function listCameras() {
      try {
        addDebugLog('カメラ検出中...');
        const devices = await navigator.mediaDevices.enumerateDevices();
        const cams = devices.filter(d => d.kind === 'videoinput');
        addDebugLog(`検出: ${cams.length}台`);
        cams.forEach((c, i) => {
          addDebugLog(`  カメラ${i+1}: ${c.label || 'Unknown'} (ID:${c.deviceId})`);
        });
        return cams;
      } catch (e) {
        addDebugLog(`カメラ検出エラー: ${e.message}`);
        return [];
      }
    }

    // 画面・変数リセット
    function resetAll() {
      code1 = code2 = null;
      code1El.textContent = code2El.textContent = '—';
      statusEl.textContent = '１回目のスキャンをしてください';
      statusEl.className = 'status';
    }

    // バーコード内容の一時表示
    function showBarcodeContent(content, first) {
      overlayEl.textContent = content;
      overlayEl.className = 'barcode';
      overlayEl.style.display = 'flex';
      addDebugLog((first ? '1回目' : '2回目') + `表示: ${content}`);
      setTimeout(() => {
        overlayEl.style.display = 'none';
        if (!first) {
          setTimeout(() => {
            const match = code1 === code2;
            addDebugLog(`照合: ${match ? '一致' : '不一致'}`);
            showResult(match);
          }, 200);
        }
      }, 1000);
    }

    // 照合結果を大表示
    function showResult(match) {
      overlayEl.textContent = match ? '〇' : '×';
      overlayEl.className = 'result';
      overlayEl.style.color = match ? 'green' : 'red';
      overlayEl.style.display = 'flex';
      setTimeout(() => {
        overlayEl.style.display = 'none';
        resetAll();
      }, 2000);
    }

    // スキャン成功
    function onScanSuccess(decodedText) {
      addDebugLog(`読み取り成功: ${decodedText}`);
      if (code1 === null) {
        code1 = decodedText;
        code1El.textContent = decodedText;
        statusEl.textContent = '２回目のスキャンをしてください';
        addDebugLog('1回目完了');
        showBarcodeContent(decodedText, true);
      } else if (code2 === null) {
        code2 = decodedText;
        code2El.textContent = decodedText;
        addDebugLog('2回目完了');
        showBarcodeContent(decodedText, false);
      }
    }

    // スキャン失敗
    function onScanFailure(error) {
      addDebugLog(`読み取り失敗: ${error}`);
    }

    // カメラ開始（前セッションのクリーンアップ含む）
    async function startScanner() {
      try {
        if (html5QrCode && isScanning) {
          addDebugLog('前のセッションを停止します');
          await html5QrCode.stop();
          html5QrCode.clear();
          isScanning = false;
        }

        addDebugLog('スキャン開始処理...');
        if (!html5QrCode) {
          html5QrCode = new Html5Qrcode('reader');
          addDebugLog('Html5Qrcodeインスタンス生成');
        }

        // カメラ一覧から背面カメラを選択
        const cams = await listCameras();
        const backCam = cams.find(c => /背面|environment/i.test(c.label));
        const cameraConfig = backCam
          ? { deviceId: { exact: backCam.deviceId } }
          : { facingMode: 'environment' };

        // 読み取り設定（QR・GS1限定型のみ）
        const config = {
          fps: 12,
          qrbox: { width: 300, height: 300 },
          formatsToSupport: [
            Html5QrcodeSupportedFormats.QR_CODE,
            Html5QrcodeSupportedFormats.RSS_LIMITED
          ],
          verbose: false
        };

        startBtn.disabled = true;
        addDebugLog('html5QrCode.start 実行...');
        await html5QrCode.start(
          cameraConfig,
          config,
          onScanSuccess,
          onScanFailure
        );

        isScanning = true;
        addDebugLog('カメラ起動成功');
        statusEl.textContent = '１回目のスキャンをしてください';
        statusEl.className = 'status ok';

        // ボタン表示切替
        startBtn.style.display = 'none';
        stopBtn.style.display  = 'block';
        resetAll();
      } catch (e) {
        addDebugLog(`起動エラー: ${e.message}`);
        statusEl.textContent = `カメラエラー: ${e.message}`;
        statusEl.className = 'status ng';
        startBtn.disabled = false;
      }
    }

    // カメラ停止ボタン
    stopBtn.addEventListener('click', async () => {
      if (html5QrCode && isScanning) {
        await html5QrCode.stop();
        html5QrCode.clear();
        isScanning = false;
        addDebugLog('スキャンを停止しました');
        // ボタン表示切替
        stopBtn.style.display  = 'none';
        startBtn.style.display = 'block';
        startBtn.disabled      = false;
        statusEl.textContent   = 'カメラを停止しました';
        statusEl.className     = 'status';
      }
    });

    // 初期化
    window.addEventListener('load', async () => {
      addDebugLog('ページ読み込み完了');
      if (typeof Html5Qrcode === 'undefined') {
        addDebugLog('ライブラリ未ロードエラー');
        statusEl.textContent = 'ライブラリ読み込みエラー';
        statusEl.className   = 'status ng';
        return;
      }
      if (!checkEnvironment()) {
        statusEl.textContent = 'ブラウザ未対応';
        statusEl.className   = 'status ng';
        return;
      }
      await listCameras();
      startBtn.addEventListener('click', startScanner);
      addDebugLog('初期化完了');
    });

    // ページ離脱時はストリーム停止
    window.addEventListener('beforeunload', () => {
      if (html5QrCode && isScanning) {
        html5QrCode.stop();
      }
    });
  </script>
</body>
</html>
