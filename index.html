<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç…§åˆï¼ˆQRï¼†GS1é™å®šå‹ï¼‰</title>
  <!-- HTML5-QRCode ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"
          crossorigin="anonymous"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0.5rem;
      padding: 0;
      background: #f5f5f5;
    }
    
    .container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #debug {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      padding: 0.5rem;
      margin-bottom: 1rem;
      border-radius: 4px;
      font-size: 0.75rem;
      max-height: 150px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    
    #reader {
      width: 100%;
      height: 250px;
      margin: 1rem 0;
      border: 2px dashed #007bff;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }
    
    /* ã‚«ãƒ¡ãƒ©ãƒ“ãƒ¥ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
    #reader video {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover !important;
    }
    
    /* QRãƒœãƒƒã‚¯ã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
    #reader canvas {
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
    }
    
    .status {
      text-align: center;
      font-size: 1.1rem;
      margin: 1rem 0;
      padding: 0.5rem;
      border-radius: 4px;
    }
    .status.ok { 
      background: #d4edda; 
      color: #155724; 
      border: 1px solid #c3e6cb;
    }
    .status.ng { 
      background: #f8d7da; 
      color: #721c24; 
      border: 1px solid #f5c6cb;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .values {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 4px;
      margin: 1rem 0;
    }
    .values p { 
      margin: 0.5rem 0; 
      font-weight: bold;
      word-break: break-all;
    }
    
    #overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.95);
      align-items: center;
      justify-content: center;
      z-index: 999;
      text-align: center;
      padding: 2rem;
      box-sizing: border-box;
    }
    #overlay.barcode {
      font-size: 1.5rem;
      background: rgba(0, 123, 255, 0.95);
      color: white;
      font-weight: bold;
    }
    #overlay.result {
      font-size: 6rem;
      font-weight: bold;
    }
    
    button {
      display: block;
      margin: 1rem auto;
      padding: 1rem 2rem;
      font-size: 1.2rem;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      max-width: 300px;
      font-weight: bold;
      min-height: 50px;
    }
    button:hover:not(:disabled) { 
      background: #0056b3; 
    }
    button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    
    .camera-tips {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
      padding: 0.75rem;
      border-radius: 4px;
      margin: 1rem 0;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
    <div id="debug">ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...</div>
    
    <!-- ã‚«ãƒ¡ãƒ©ä½¿ç”¨ã®ãƒ’ãƒ³ãƒˆ -->
    <div class="camera-tips">
      ğŸ“± <strong>ã‚«ãƒ¡ãƒ©ä½¿ç”¨ã®ã‚³ãƒ„:</strong><br>
      â€¢ ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒ¡ãƒ©ã‹ã‚‰15-20cmé›¢ã™<br>
      â€¢ æ˜ã‚‹ã„å ´æ‰€ã§ä½¿ç”¨ã™ã‚‹<br>
      â€¢ ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãŒæ å†…ã«åã¾ã‚‹ã‚ˆã†ã«ã™ã‚‹
    </div>
    
    <!-- æ“ä½œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
    <div id="status" class="status info">ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹ã—ã¦ãã ã•ã„</div>
    
    <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
    <button id="startBtn">ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹</button>
    <button id="stopBtn" style="display:none;">â¹ï¸ ã‚«ãƒ¡ãƒ©ã‚’åœæ­¢</button>
    
    <!-- ã‚«ãƒ¡ãƒ©æ˜ åƒã‚¨ãƒªã‚¢ -->
    <div id="reader"></div>
    
    <!-- èª­ã¿å–ã‚Šå€¤ã®è¡¨ç¤º -->
    <div class="values">
      <p>ğŸ”µ ãƒãƒ¼ã‚³ãƒ¼ãƒ‰â‘ ï¼š<span id="code1">â€”</span></p>
      <p>ğŸ”´ ãƒãƒ¼ã‚³ãƒ¼ãƒ‰â‘¡ï¼š<span id="code2">â€”</span></p>
    </div>
    
    <!-- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="overlay"></div>
  </div>

  <script>
    // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    window.addEventListener('error', event => {
      addDebugLog(`ğŸš¨ ã‚¨ãƒ©ãƒ¼: ${event.message}`);
    });

    let code1 = null, code2 = null;
    let html5QrCode = null, isScanning = false;

    const debugEl = document.getElementById('debug');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusEl = document.getElementById('status');
    const code1El = document.getElementById('code1');
    const code2El = document.getElementById('code2');
    const overlayEl = document.getElementById('overlay');

    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
    function addDebugLog(msg) {
      const time = new Date().toLocaleTimeString();
      debugEl.textContent += `[${time}] ${msg}\n`;
      debugEl.scrollTop = debugEl.scrollHeight;
      console.log(`[${time}] ${msg}`);
    }

    // ç’°å¢ƒãƒã‚§ãƒƒã‚¯
    function checkEnvironment() {
      addDebugLog('ğŸ” ç’°å¢ƒãƒã‚§ãƒƒã‚¯é–‹å§‹');
      addDebugLog(`ğŸ“ URL: ${location.href}`);
      addDebugLog(`ğŸ”’ ãƒ—ãƒ­ãƒˆã‚³ãƒ«: ${location.protocol}`);
      
      // HTTPS ãƒã‚§ãƒƒã‚¯
      const isSecure = location.protocol === 'https:' || 
                      location.hostname === 'localhost' || 
                      location.hostname === '127.0.0.1';
      
      if (!isSecure) {
        addDebugLog('âš ï¸ è­¦å‘Š: HTTPSå¿…é ˆã€‚ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ã®å¯èƒ½æ€§');
        return false;
      }
      
      // MediaDevices API ãƒã‚§ãƒƒã‚¯
      if (!navigator.mediaDevices) {
        addDebugLog('âŒ MediaDevices APIæœªå¯¾å¿œ');
        return false;
      }
      
      if (!navigator.mediaDevices.getUserMedia) {
        addDebugLog('âŒ getUserMediaæœªå¯¾å¿œ');
        return false;
      }
      
      addDebugLog('âœ… ç’°å¢ƒãƒã‚§ãƒƒã‚¯å®Œäº†');
      return true;
    }

    // ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡º
    async function detectCameras() {
      try {
        addDebugLog('ğŸ“¹ ã‚«ãƒ¡ãƒ©æ¤œå‡ºä¸­...');
        
        // æ¨©é™è¦æ±‚ã‚’å«ã‚€æ¤œå‡º
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        stream.getTracks().forEach(track => track.stop()); // å³åœæ­¢
        
        const devices = await navigator.mediaDevices.enumerateDevices();
        const cameras = devices.filter(device => device.kind === 'videoinput');
        
        addDebugLog(`ğŸ“¹ æ¤œå‡ºã‚«ãƒ¡ãƒ©æ•°: ${cameras.length}`);
        cameras.forEach((camera, index) => {
          const label = camera.label || `ã‚«ãƒ¡ãƒ©${index + 1}`;
          addDebugLog(`  ğŸ“¹ ${label}`);
        });
        
        return cameras;
      } catch (error) {
        addDebugLog(`âŒ ã‚«ãƒ¡ãƒ©æ¤œå‡ºã‚¨ãƒ©ãƒ¼: ${error.message}`);
        if (error.name === 'NotAllowedError') {
          addDebugLog('âš ï¸ ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ');
        }
        return [];
      }
    }

    // ãƒªã‚»ãƒƒãƒˆ
    function resetAll() {
      code1 = code2 = null;
      code1El.textContent = code2El.textContent = 'â€”';
      statusEl.textContent = 'ï¼‘å›ç›®ã®ã‚¹ã‚­ãƒ£ãƒ³ã‚’ã—ã¦ãã ã•ã„';
      statusEl.className = 'status info';
    }

    // ãƒãƒ¼ã‚³ãƒ¼ãƒ‰å†…å®¹è¡¨ç¤º
    function showBarcodeContent(content, isFirst) {
      overlayEl.textContent = content;
      overlayEl.className = 'barcode';
      overlayEl.style.display = 'flex';
      
      addDebugLog(`ğŸ“Š ${isFirst ? '1å›ç›®' : '2å›ç›®'}ã‚¹ã‚­ãƒ£ãƒ³: ${content}`);
      
      setTimeout(() => {
        overlayEl.style.display = 'none';
        overlayEl.className = '';
        
        if (!isFirst) {
          setTimeout(() => {
            const isMatch = code1 === code2;
            addDebugLog(`ğŸ” ç…§åˆçµæœ: ${isMatch ? 'âœ… ä¸€è‡´' : 'âŒ ä¸ä¸€è‡´'}`);
            showResult(isMatch);
          }, 300);
        }
      }, 1000);
    }

    // çµæœè¡¨ç¤º
    function showResult(isMatch) {
      overlayEl.textContent = isMatch ? 'âœ…' : 'âŒ';
      overlayEl.className = 'result';
      overlayEl.style.color = isMatch ? '#28a745' : '#dc3545';
      overlayEl.style.display = 'flex';
      
      setTimeout(() => {
        overlayEl.style.display = 'none';
        overlayEl.className = '';
        resetAll();
      }, 2000);
    }

    // ã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸ
    function onScanSuccess(decodedText, decodedResult) {
      addDebugLog(`ğŸ“± èª­ã¿å–ã‚ŠæˆåŠŸ: ${decodedText}`);
      
      if (code1 === null) {
        code1 = decodedText;
        code1El.textContent = decodedText;
        statusEl.textContent = 'ï¼’å›ç›®ã®ã‚¹ã‚­ãƒ£ãƒ³ã‚’ã—ã¦ãã ã•ã„';
        statusEl.className = 'status info';
        showBarcodeContent(decodedText, true);
      } else if (code2 === null) {
        code2 = decodedText;
        code2El.textContent = decodedText;
        showBarcodeContent(decodedText, false);
      }
    }

    // ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—ï¼ˆè©³ç´°ãƒ­ã‚°ã¯å‡ºã•ãªã„ï¼‰
    function onScanFailure(error) {
      // èª­ã¿å–ã‚Šå¤±æ•—ã¯æ­£å¸¸å‹•ä½œãªã®ã§ãƒ­ã‚°å‡ºåŠ›ã—ãªã„
    }

    // ã‚«ãƒ¡ãƒ©é–‹å§‹
    async function startScanner() {
      try {
        addDebugLog('ğŸš€ ã‚«ãƒ¡ãƒ©é–‹å§‹å‡¦ç†...');
        
        // æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        if (html5QrCode && isScanning) {
          await html5QrCode.stop();
          isScanning = false;
        }

        startBtn.disabled = true;
        startBtn.textContent = 'â³ èµ·å‹•ä¸­...';

        // Html5Qrcode ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
        if (!html5QrCode) {
          html5QrCode = new Html5Qrcode('reader');
          addDebugLog('ğŸ“¹ Html5Qrcodeã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ');
        }

        // ã‚«ãƒ¡ãƒ©è¨­å®šï¼ˆèƒŒé¢ã‚«ãƒ¡ãƒ©å„ªå…ˆï¼‰
        const cameraConfig = { 
          facingMode: 'environment',
          advanced: [
            { focusMode: 'continuous' },
            { zoom: 1.0 }
          ]
        };

        // ã‚¹ã‚­ãƒ£ãƒ³è¨­å®šï¼ˆæœ€é©åŒ–æ¸ˆã¿ï¼‰
        const scanConfig = {
          fps: 15, // ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆå‘ä¸Š
          qrbox: function(viewfinderWidth, viewfinderHeight) {
            // å‹•çš„ã‚µã‚¤ã‚ºèª¿æ•´
            const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
            const qrboxSize = Math.floor(minEdge * 0.7);
            return {
              width: qrboxSize,
              height: qrboxSize
            };
          },
          aspectRatio: 1.0,
          // QRã‚³ãƒ¼ãƒ‰ã¨GS1é™å®šå‹ã®ã¿
          formatsToSupport: [
            Html5QrcodeSupportedFormats.QR_CODE,
            Html5QrcodeSupportedFormats.RSS_LIMITED
          ],
          experimentalFeatures: {
            useBarCodeDetectorIfSupported: true
          }
        };

        addDebugLog('ğŸ“¹ ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­...');
        await html5QrCode.start(
          cameraConfig,
          scanConfig,
          onScanSuccess,
          onScanFailure
        );

        isScanning = true;
        addDebugLog('âœ… ã‚«ãƒ¡ãƒ©èµ·å‹•æˆåŠŸ');
        
        // UIæ›´æ–°
        statusEl.textContent = 'ï¼‘å›ç›®ã®ã‚¹ã‚­ãƒ£ãƒ³ã‚’ã—ã¦ãã ã•ã„';
        statusEl.className = 'status ok';
        startBtn.style.display = 'none';
        stopBtn.style.display = 'block';
        
        resetAll();

      } catch (error) {
        addDebugLog(`âŒ ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—: ${error.message}`);
        
        let errorMessage = 'ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
        if (error.name === 'NotAllowedError') {
          errorMessage = 'ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„';
        } else if (error.name === 'NotFoundError') {
          errorMessage = 'ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
        } else if (error.name === 'NotSupportedError') {
          errorMessage = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ã‚«ãƒ¡ãƒ©ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“';
        }
        
        statusEl.textContent = errorMessage;
        statusEl.className = 'status ng';
        startBtn.disabled = false;
        startBtn.textContent = 'ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹';
      }
    }

    // ã‚«ãƒ¡ãƒ©åœæ­¢
    async function stopScanner() {
      try {
        if (html5QrCode && isScanning) {
          await html5QrCode.stop();
          isScanning = false;
          addDebugLog('â¹ï¸ ã‚«ãƒ¡ãƒ©ã‚’åœæ­¢ã—ã¾ã—ãŸ');
        }
        
        // UIæ›´æ–°
        startBtn.style.display = 'block';
        startBtn.disabled = false;
        startBtn.textContent = 'ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹';
        stopBtn.style.display = 'none';
        statusEl.textContent = 'ã‚«ãƒ¡ãƒ©ã‚’åœæ­¢ã—ã¾ã—ãŸ';
        statusEl.className = 'status info';
        
      } catch (error) {
        addDebugLog(`âŒ åœæ­¢ã‚¨ãƒ©ãƒ¼: ${error.message}`);
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    startBtn.addEventListener('click', startScanner);
    stopBtn.addEventListener('click', stopScanner);

    // åˆæœŸåŒ–
    window.addEventListener('load', async () => {
      addDebugLog('ğŸ”„ ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
      
      // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒã‚§ãƒƒã‚¯
      if (typeof Html5Qrcode === 'undefined') {
        addDebugLog('âŒ Html5Qrcodeãƒ©ã‚¤ãƒ–ãƒ©ãƒªæœªèª­ã¿è¾¼ã¿');
        statusEl.textContent = 'ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼';
        statusEl.className = 'status ng';
        return;
      }
      addDebugLog('âœ… Html5Qrcodeãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿æˆåŠŸ');

      // ç’°å¢ƒãƒã‚§ãƒƒã‚¯
      if (!checkEnvironment()) {
        statusEl.textContent = 'ãƒ–ãƒ©ã‚¦ã‚¶ãŒã‚«ãƒ¡ãƒ©ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“';
        statusEl.className = 'status ng';
        return;
      }

      // ã‚«ãƒ¡ãƒ©æ¤œå‡º
      await detectCameras();
      
      addDebugLog('ğŸ‰ åˆæœŸåŒ–å®Œäº†');
      statusEl.textContent = 'ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹ã—ã¦ãã ã•ã„';
      statusEl.className = 'status info';
    });

    // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    window.addEventListener('beforeunload', () => {
      if (html5QrCode && isScanning) {
        html5QrCode.stop().catch(() => {});
      }
    });

    // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å¾©å¸°æ™‚ã®å‡¦ç†
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible' && isScanning) {
        addDebugLog('ğŸ”„ ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å¾©å¸°');
      }
    });
  </script>
</body>
</html>
